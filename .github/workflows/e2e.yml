name: E2E Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always

jobs:
  e2e:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2

      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y subversion

      - name: Verify tools
        run: svn --version --quiet && svnadmin --version --quiet && git --version

      - name: Build project
        run: cargo build --workspace

      - name: Run E2E tests
        timeout-minutes: 10
        run: |
          set -euo pipefail
          cargo test --workspace --test '*' -- --nocapture 2>&1 | tee test-output.txt
          # Guard: fail if zero tests were executed across all test binaries.
          total=$(grep -Eo '[0-9]+ passed' test-output.txt | awk '{s+=$1} END {print s+0}')
          echo "Total tests passed: $total"
          if [ "$total" -eq 0 ]; then
            echo "::error::E2E job executed zero tests â€” check test filters"
            exit 1
          fi
        env:
          RUST_BACKTRACE: 1
          GIT_AUTHOR_NAME: "Test User"
          GIT_AUTHOR_EMAIL: "test@example.com"
          GIT_COMMITTER_NAME: "Test User"
          GIT_COMMITTER_EMAIL: "test@example.com"
